---
layout: post
collection: kubernetes
permalink: /kubernetes/helm
title:  "Helm Charts"
author: Paulo Rogério
date:   2025-10-07 06:00:00 -0300
categories: [kubernetes]
published: true
---

# Estudos Helm Chart 

- [1) Propósito](#1-versão-do-helm)
- [2) Usando Helm](#2-usando-helm)
  - [2.1) Criando um Chart](#21-criando-um-chart)
  - [2.2) Estrutura do Chart](#22-estrutura-do-chart)
- [3) Objetos do Helm](#3-objetos-do-helm)
- [4) Funções](#4-funções)
  - [4.1) Quote](#41-quote)
  - [4.2) Operadores](#42-operadores)
    - [4.2.1) Operadores de Comparação](#421-operadores-de-comparação)
    - [4.2.2) Operadores Lógicos](#422-operadores-lógicos)
    - [4.2.3) Operadores Aritméticos](#423-operadores-aritméticos)
    - [4.2.4) Operadores String](#424-operadores-string)
- [5) Tipos de Dados](#5-tipos-de-dados)
- [6) Percorrendo Dados com With](#6-percorrendo-dados-com-with)
- [7) Função Range](#7-função-range)
- [8) Função toYaml](#8-função-toYaml)
- [9) Função Lookup](#9-função-lookup)
- [10) Notes](#10-notes)


## 1) Propósito

O propósito desse material é garantir o entendimento do Helm para construirmos charts mais robustos.
Não tem o Helm instalado? [Clique Aqui](https://helm.sh/docs/intro/quickstart) para ter as instruções de instalação.

## 2) Usando Helm

Adicionando repositório...

```bash
helm repo list
helm repo add bitnami https://charts.bitnami.com/bitnami
help repo update
```

Sintaxe de instalação...

```bash
                        ( repo )/( pacote)  
helm install my-release bitnami/phpmyadmin
helm list -A
helm list -n namespace
```

Como instalar um determinado release?

```bash
helm install <nome-do-release> <nome-do-repositório>/<nome-do-chart> --version <versão>
helm install meu-prometheus prometheus-community/prometheus --version 25.8.0
```

Desinstalar um deploy

```bash
helm uninstall meu-prometheus
```

#### 2.1) Criando um Chart

Estou criando um chart chamado *meu-chart*. Ao executar o comando, ele já presume e cria alguns manifestos ( deployments, services, hpa...)

```bash
helm create meu-chart
```

#### 2.2) Estrutura do Chart

Após criado o chart, alguns arquivos podem ser excluídos para manter dentro do chart apenas os arquivos necessário para contemplar os estudos.

```bash
echo "" > meu-chart/values.yaml
rm -f meu-chart/templates/*
```

Crie o conteudo do configmap.yaml com a seguinte sintaxe.

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
EOF
{% endraw %}
```

```yaml
├── Chart.yaml
├── templates
│   ├── configmap.yaml
└── values.yaml
```

Executando no modo **dry-run** e validar a saida do manifesto gerado...

```bash
helm install --dry-run meuchart-v1 ./meu-chart
```

Modo debug...

```bash
helm install --debug --dry-run meuchart-v1 ./meu-chart
```


```bash
NAME: meuchart-v1
LAST DEPLOYED: Tue Oct  7 09:12:24 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meuchart-v1-configmap
data:
  myvalue: "Hello World
```

## 3) Objetos do Helm

**Built-in Objects** são variáveis globais que o motor de templates (Go templating engine) injeta automaticamente quando o Helm renderiza seus manifests.

Como eu descubro o nome dos Objetos nativos do Helm? [Built-in Objects - List](https://helm.sh/docs/chart_template_guide/builtin_objects/)


| Nome                 | Descrição                                                                       | Exemplo                                        |
| -------------------- | ------------------------------------------------------------------------------- | ---------------------------------------------- |
|:---|:---:|---:|
| **.Release**         | Informações sobre a *release* atual (nome, namespace, tempo, etc.)              | **{{ "{{" }} .Release.Name {{ "}} }} → myapp** |
| **.Chart**           | Dados do chart atual (nome, versão, descrição, etc.)                            | **{{ "{{" }} .Chart.Name {{ "}} }} → meu-chart** |
| **.Values**          | Valores vindos do **values.yaml** e **--set**                                   | **{{ "{{" }} .Values.image.repository {{ "}} }}** |
| **.Files**           | Permite ler arquivos dentro do chart                                            | **{{ "{{" }} (.Files.Get "config/app.conf") {{ "}} }}** |
| **.Capabilities**    | Mostra recursos suportados pelo cluster (versão do K8s, APIs, etc.)             | **{{ "{{" }} .Capabilities.KubeVersion.Version {{ "}} }}** |
| **.Template**        | Informações sobre o arquivo de template sendo renderizado                       | **{{ "{{" }} .Template.Name {{ "}} }}**                    |
| -------------------- | ------------------------------------------------------------------------------- | ---------------------------------------------- |


## 4) Funções

Vamos detalhar alguns funções, usadas no dia a dia. O entendimento dessa funções permitirá uma construção mais robusta dos **Helm Chart**. 

##### 4.1) Quote


```bash
cat > meu-chart/values.yaml <<EOF
bebida: refrigerante
favorita:
  bebida: cafe
  comida: pizza
EOF
```

###### String Sem Aspas - Quote

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: {{ .Values.favorita.bebida }}
  comida: {{ .Values.favorita.comida }}
EOF
{% endraw %}
```

```bash
helm install --dry-run meu-chart ./meu-chart
```

Observe na saida abaixo que os values **NÃO VIERAM PROTEGIDOS** por aspas, o **Helm** espera que eu explicite isso.

```yaml
NAME: meu-chart
LAST DEPLOYED: Tue Oct  7 09:52:14 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: cafe
  comida: pizza
```


###### String Com Aspas - Quote

Funções conhecidas como pipeline, ou seja, redireciona a saida de um comando para outro.

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: {{ .Values.favorita.bebida | quote }}
  comida: {{ .Values.favorita.comida | quote }}
EOF
{% endraw %}
```

```bash
helm install --dry-run meu-chart ./meu-chart
```


```yaml
NAME: meu-chart
LAST DEPLOYED: Tue Oct  7 11:11:39 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: "cafe"
  comida: "pizza"
```

## 4.2) Operadores

No **Helm** podemos trabalhar com os seguintes de operadores, são eles: 
- **Operadores Lógico**
- **Operadores de Comparação**
- **Operadores Aritiméticos**
- **Operdores de String**
- **Operadores de Lista e Dicionários**

 Vamos detalhar cada um e como melhor usa-lo.


### 4.2.1) Operadores de Comparação

Comparando valores...


|  Operador   | Função |                            Exemplo                   | Resultado      |
|:---:|:---:|:---|:---:|
| ----------- | ------ | -----------------------------------------------------| -------------- |
| `==`        | `eq`   | {% raw %}{{ if eq .Values.env "prod" }}{% endraw %}  | `true`/`false` |
| `!=`        | `ne`   | {% raw %}{{ if ne .Values.env "dev" }}{% endraw %}   | `true`/`false` |
| `>`         | `gt`   | {% raw %}{{ if gt .Values.replicas 1 }}{% endraw %}  | `true`/`false` |
| `<`         | `lt`   | {% raw %}{{ if lt .Values.replicas 10 }}{% endraw %} | `true`/`false` |
| `>=`        | `ge`   | {% raw %}{{ if ge .Values.replicas 3 }}{% endraw %}  | `true`/`false` |
| `<=`        | `le`   | {% raw %}{{ if le .Values.replicas 5 }}{% endraw %}  | `true`/`false` |

### Ex:

```yaml
{% raw %}

{{- if and (eq .Values.env "prod") (gt .Values.replicas 2) }}
replicas: {{ .Values.replicas }}
{{- else }}
replicas: 1
{{- end }}

{% endraw %}
```


### 4.2.2) Operadores Lógicos

Visualmente mais clean, permitindo trabalhar com múltiplas condições...


| Operador | Descrição                                            | Exemplo                                                                           |
|:---:|:---:|:---|
| -------- | ---------------------------------------------------- | --------------------------------------------------------------------------------- |
| `and`    | Retorna verdadeiro se **ambos** forem verdadeiros    | {% raw %}{{ if and (eq .Values.env "prod") (gt .Values.replicas 3) }}{% endraw %} |
| `or`     | Retorna verdadeiro se **um dos dois** for verdadeiro | {% raw %}{{ if or (eq .Values.env "dev") (eq .Values.env "test") }}{% endraw %}   |
| `not`    | Nega o valor lógico                                  | {% raw %}{{ if not .Values.enabled }}{% endraw %}                                 |


```yaml
{% raw %}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-config
data:
  env: {{ .Values.env }}
  replicas: {{ .Values.replicas }}
  {{- if and (eq .Values.env "prod") (ge .Values.replicas 3) }}
  mode: "high-availability"
  {{- else }}
  mode: "standard"
  {{- end }}

{% endraw %}
```


### 4.2.3) Operadores Aritméticos


Operações...

| Operador | Função | Exemplo          | Resultado |
| -------- | ------ | ---------------- | --------- |
|:---:|:---:|:---|:---|
| `+`      | `add`  | {% raw %}{{ add 2 3 }}{% endraw %}  | `5`       |
| `-`      | `sub`  | {% raw %}{{ sub 10 4 }}{% endraw %} | `6`       |
| `*`      | `mul`  | {% raw %}{{ mul 2 5 }}{% endraw %}  | `10`      |
| `/`      | `div`  | {% raw %}{{ div 10 2 }}{% endraw %} | `5`       |
| `%`      | `mod`  | {% raw %}{{ mod 10 3 }}{% endraw %} | `1`       |


### 4.2.4) Operadores String

Tratando strings...

| Operador                 | Função    | Exemplo                              | Resultado                |
| ------------------------ | --------- | ------------------------------------ | ------------------------ |
|:---:|:---:|:---|:---|
| Concatenação             | `cat`     | `{{ cat .Values.name "-svc" }}`      | `myapp-svc`              |
| Conversão para maiúscula | `upper`   | `{{ upper .Values.env }}`            | `PROD`                   |
| Conversão para minúscula | `lower`   | `{{ lower .Values.env }}`            | `prod`                   |
| Substring / replace      | `replace` | `{{ replace "-" "_" .Values.name }}` | Substitui hífens por `_` |


### Ex:

```bash
cat > meu-chart/values.yaml <<EOF
favorita:
  comida: pizza
  temperatura: quente
EOF
```

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: {{ .Values.favorita.bebida | default "cha" | quote }}
  comida: {{ .Values.favorita.comida | upper | quote }}
  {{- if and (eq .Values.favorita.bebida "cafe") (eq .Values.favorita.temperatura "quente") }}
  caneca: "sim"
  protetor: "sim"
  {{- else if and (eq .Values.favorita.bebida "cafe") (eq .Values.favorita.temperatura "fria") }}
  caneca: "sim"
  protetor: "nao"
  {{ else }}
  caneca: "nao"
  protetor: "nao"
  {{- end }}
EOF
{% endraw %}
```

```bash
helm install --dry-run meu-chart ./meu-chart
```

```yaml
NAME: meu-chart
LAST DEPLOYED: Thu Oct  9 10:22:08 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: "cha"
  comida: "PIZZA"
  caneca: "nao"
  protetor: "nao"
```

### Ex:


```bash
cat > meu-chart/values.yaml <<EOF
configmap:
  enabled: true
favorita:
  bebida: refrigerante
  comida: pizza
EOF
```

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
{{- if (eq .Values.configmap.enabled true) }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: {{ .Values.favorita.bebida }}
  comida: {{ .Values.favorita.comida }}
{{- end }}
EOF
{% endraw %}
```

```yaml
NAME: meu-chart
LAST DEPLOYED: Thu Oct  9 10:32:38 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: refrigerante
  comida: pizza
```

## 5) Tipos de Dados

Segue uma tabelas com os tipos de dados e sua características.

| Tipo          | Descrição                                                          |
| ------------  | -----------------------------------------------------------------  |
|:---:|:---:|
| **string**    | Sequência de caracteres (`"foo"`, `"bar"`)                         |
| **int**       | Números inteiros (`1`, `42`, `-3`)                                 |
| **float**     | Números com ponto decimal (`3.14`, `2.0`)                          |
| **bool**      | Valores booleanos (`true`, `false`)                                |
| **list**      | Lista (array) de itens (`[1, 2, 3]`, `["a", "b"]`)                 |
| **dict / map**|  Mapa de chave-valor (`{ foo: bar }`, em YAML `foo: bar`)          |
| **nil**      | Valor nulo (equivale ao `null` em YAML, ou `nil` em Go templates)   |


## 6) Percorrendo Dados com With

Busca uma informação a partir de um ponto, simplificando a buscar do dado.


```bash
cat > meu-chart/values.yaml <<EOF
favorita:
  bebida: refrigerante
  comida: pizza
EOF
```

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  {{- with .Values.items }}
  bebida: {{ .bebida }}
  comida: {{ .comida }}
  {{- end }}
EOF
{% endraw %}  
```

Não trouxe nem **bebiba** nem **comida**, pois não existe a chave **Itens**.

```bash
helm install --dry-run meu-chart ./meu-chart
NAME: meu-chart
LAST DEPLOYED: Thu Oct  9 11:12:42 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
```

## 7) Função Range

Permite percorrer uma lista usando a função **range**, iterando item por item. Ele iterar sobre listas, arrays, mapas ou dicionários dentro de um chart.

```bash
cat > meu-chart/values.yaml <<EOF
favorita:
  bebida:
    - refrigerante
    - cerveja
    - cafe
    - agua
  comida:
    - pizza
    - churrasco
    - macarrao
    - lasanha
EOF
```

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: |-
    {{- range .Values.favorita.bebida }}
    - {{ . | quote }}
    {{- end }}
  comida: |-
    {{- range .Values.favorita.comida }}
    - {{ . | quote }}
    {{- end }}
EOF
{% endraw %}  
```

```bash
helm install --dry-run meu-chart ./meu-chart
```

```bash
NAME: meu-chart
LAST DEPLOYED: Thu Oct  9 11:21:07 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: |-
    - "refrigerante"
    - "cerveja"
    - "cafe"
    - "agua"
  comida: |-
    - "pizza"
    - "churrasco"
    - "macarrao"
    - "lasanha"
```


```bash
cat > meu-chart/values.yaml <<EOF
favorita:
  bebida: "café"
  comida: "lasanha"

ingredientes:
  - nome: "queijo mussarela"
    local: "mercado central"
  - nome: "massa fresca"
    local: "padaria do bairro"
  - nome: "molho de tomate"
    local: "mercearia da esquina"
EOF
```

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  myvalue: "Hello World"
  bebida: {{ .Values.favorita.bebida }}
  comida: {{ .Values.favorita.comida }}
  ingredientes: |-
    {{- range .Values.ingredientes }}
    - nome: {{ .nome | quote }}
      local: {{ .local | quote }}
    {{- end }}
EOF
{% endraw %}  
```

```bash
helm install --dry-run meu-chart ./meu-chart
```

```yaml
NAME: meu-chart
LAST DEPLOYED: Mon Oct 13 06:05:56 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: meu-chart-configmap
data:
  myvalue: "Hello World"
  bebida: café
  comida: lasanha
  ingredientes: |-
    - nome: "queijo mussarela"
      local: "mercado central"
    - nome: "massa fresca"
      local: "padaria do bairro"
    - nome: "molho de tomate"
      local: "mercearia da esquina"
```

## 8) Função toYaml

A função toYaml converte estruturas de dados **(listas, mapas, objetos)** em texto YAML formatado.

Isso...

```yaml
{% raw %}
{{ toYaml .Values.favorita.bebida }}
{% endraw %}
```

Vira isso..

```yaml
- café
- suco
- água
```

Ex:

```bash
cat > meu-chart/values.yaml <<EOF
favorita:
  bebida:
    - café
    - suco
  comida:
    - pizza
    - lasanha
EOF
```

A função nindent significa **nova linha + indentação**, ou seja, **nindent 4** adiciona 4 espaços de indentação a cada linha gerada.

O **n** (new line) garante que a indentação seja aplicada corretamente logo após a quebra de linha.

```bash
{% raw %}
cat > meu-chart/templates/configmap.yaml <<EOF
apiVersion: v1
kind: ConfigMap
metadata:
  name: teste
data:
  bebida: |-
    {{- toYaml .Values.favorita.bebida | nindent 4 }}
  comida: |-
    {{- toYaml .Values.favorita.comida | nindent 4 }}
EOF
{% endraw %}  
```

```bash
helm install --dry-run meu-chart ./meu-chart
```

```yaml
NAME: meu-chart
LAST DEPLOYED: Mon Oct 13 06:29:23 2025
NAMESPACE: default
STATUS: pending-install
REVISION: 1
TEST SUITE: None
HOOKS:
MANIFEST:
---
# Source: meu-chart/templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: teste
data:
  bebida: |-
    - café
    - suco    
  comida: |-
    - pizza
    - lasanha
```


```bash
bebidas=$(yq e '.[]' /etc/config/bebida)
for b in $bebidas; do
  echo "Servindo $b"
done
```


## 9) Função Lookup

Busca informação dentro do cluster kubernetes, ou pegar algo já criado dentro do nosso cluster.

[Função Lookup](https://helm.sh/docs/chart_template_guide/functions_and_pipelines/#using-the-lookup-function)


#
# OBS.: Ao usar lookup, nao usar --dry-run
#

| Comando Kubernetes          | Comando Equivalente no Helm                                |
| ------------  | -----------------------------------------------------------------------  |
|:---:|:---:|
| kubectl get pod mypod -n mynamespace |  ```lookup "v1" "Pod" "mynamespace" "mypod"```    |
| kubectl get pods -n mynamespace      |  ```lookup "v1" "Pod" "mynamespace" ""```         |
| kubectl get pods --all-namespaces    |  ```lookup "v1" "Pod" "" ""```                    |
| kubectl get namespace mynamespace    |  ```lookup "v1" "Namespace" "" "mynamespace"```   |
| kubectl get namespaces               |  ```lookup "v1" "Namespace" "" ""```              |


Todos as ações feitas no kubectl podem ser traduzidas para o lookup do Helm. Supondo que tenha um deployment do nginx

```bash
kubectl get service -n ingress-nginx ingress-nginx-controller -o yaml
```

#### Quero pegar o Ip do clusterIP

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  ServiceIp: {{ (lookup "v1" "Service" "ingress-nginx" "ingress-nginx-controller").spec.clusterIP }}
{% endraw %}
```

```bash
helm install meu-chart ./meu-chart
```

```bash
kubectl get configmaps -n default meu-chart-configmap -o yaml 
```

```yaml
apiVersion: v1
data:
  ServiceIp: 10.111.212.234
kind: ConfigMap
metadata:
  annotations:
    meta.helm.sh/release-name: meu-chart
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2025-10-14T01:21:58Z"
  labels:
    app.kubernetes.io/managed-by: Helm
  name: meu-chart-configmap
  namespace: default
  resourceVersion: "1689"
  uid: 27a5a897-7b7d-4c23-92f6-b2da1c67f6d4
```

Usando o mesmo exemplo, mas agora, definindo uma variável **svc** e apartir dela percorrer os objetos dentro do cluster.

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  {{- $svc := (lookup "v1" "Service" "ingress-nginx" "ingress-nginx-controller") }}
  {{- if $svc }}
  ServiceIp: "{{ $svc.spec.clusterIP }}"
  ServicePort: "{{ (index $svc.spec.ports 0).port }}"
  {{- else }}
  ServiceIp: "not found"
  ServicePort: "n/a"
  {{- end }}
{% endraw %}
```

```bash
helm upgrade meu-chart ./meu-chart
```

```bash
kubectl get configmaps -n default meu-chart-configmap -o json | jq .data
```

```json
{
  "ServiceIp": "10.111.212.234",
  "ServicePort": "80"
}
```

#### Ex: Usando Range

O range definiu 2 variaveis de escopo local **index e pod**, percorreu a saida do comando get pods ingress-nginx e iterou em cima de items. Pegou o nome do pod por meio da estrutura **metadata.name**.

**$index** = número da iteração (0, 1, 2, …).

**$pod**   = objeto do Pod.

**\|–** = cria um bloco de texto multilinha YAML (mantendo a formatação).

**-** = no início da linha (- index:) é apenas para deixar legível no YAML, simulando uma lista.

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  pods: |-
    {{- range $index, $pod := (lookup "v1" "Pod" "ingress-nginx" "").items }}
    - index: {{ $index }}
      pod: {{ $pod.metadata.name }}
    {{ end }}
{% endraw %}
```

```bash
kubectl get configmaps -n default meu-chart-configmap -o yaml 
```


```yaml
apiVersion: v1
data:
  pods: |-
    - index: 0
      pod: ingress-nginx-admission-create-vxtj4

    - index: 1
      pod: ingress-nginx-admission-patch-4kgrx

    - index: 2
      pod: ingress-nginx-controller-68697cf9d9-7xb95
kind: ConfigMap
metadata:
  annotations:
    meta.helm.sh/release-name: meu-chart
    meta.helm.sh/release-namespace: default
  creationTimestamp: "2025-10-14T01:21:58Z"
  labels:
    app.kubernetes.io/managed-by: Helm
  name: meu-chart-configmap
  namespace: default
  resourceVersion: "13174"
  uid: 27a5a897-7b7d-4c23-92f6-b2da1c67f6d4
```


A função lookup do Helm tem a assinatura: **lookup apiVersion kind namespace name**

| Parâmetro | Retorno de lookup                                 |
-------------------------------------------------------------------------|
|:---:|:---:
| ---------------- | --------------------------------------------------- |
| `""` (vazio)     | Lista (`map` com `.items`) de recursos              |
| `"algum-nome"`   | Um único recurso (objeto simples, **sem `.items`**) |


**com Pods...**


```bash
(lookup "v1" "Pod" "ingress-nginx" "")
```

Helm retorna uma lista de Pods, estruturada assim:

```yaml
items:
  - metadata:
      name: ingress-nginx-controller-abc123
  - metadata:
      name: ingress-nginx-controller-def456
```

Entao essa sintaxe vai funcionar, pois **items** existe é uma lista que pode ser percorrida.

```yaml
{% raw %}
{{- range $index, $pod := (lookup "v1" "Pod" "ingress-nginx" "").items }}
pod: {{ $pod.metadata.name }}
{{- end }}
{% endraw %}
```


**com Deployments...**

```bash
(lookup "apps/v1" "Deployment" "ingress-nginx" "ingress-nginx-controller")
```

Isso retornará um único objeto, com estrutura semelhante ao comando ( `kubectl get deployment ingress-nginx-controller -n ingress-nginx -o yaml` )

Mesmo que seja especificado um campo **(lookup "apps/v1" "Deployment" "ingress-nginx" "ingress-nginx-controller").spec**

O Helm pega somente o campo spec desse Deployment gerando um mapa, não uma lista.

Algo equivalente a isso...

```yaml
replicas: 1
selector:
  matchLabels:
    app.kubernetes.io/name: ingress-nginx
template:
  metadata:
    labels:
      app.kubernetes.io/name: ingress-nginx
  spec:
    containers:
      - name: controller
        image: k8s.gcr.io/ingress-nginx/controller:v1.0.0
```

Ou seja, isso é um mapa (dict) com chaves e valores YAML, **não uma lista ([])** e não contém .items.

##### O LOOKUP SÓ RETORNA UMA LISTA (.items) QUANDO O ULTIMO PARAMETRO (name) É VAZIO.

```bash
lookup "apps/v1" "Deployment" "ingress-nginx" ""
```

```yaml
items:
  - metadata:
      name: ingress-nginx-controller
    spec:
      ...
  - metadata:
      name: outro-deploy
    spec:
      ...
```


```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  {{- $deploy := (lookup "apps/v1" "Deployment" "ingress-nginx" "ingress-nginx-controller") }}
  {{- if $deploy }}
  name: {{ $deploy.metadata.name }}
  namespace: {{ $deploy.metadata.namespace }}
  replicas: "{{ $deploy.spec.replicas }}"
  {{- else }}
  message: "Deployment ingress-nginx-controller not found"
  {{- end }}
{% endraw %}
```

#### Ex: Usando indexes.

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  {{- range $index, $pod := (lookup "v1" "Pod" "ingress-nginx" "").items }}
  pod: {{ $pod.metadata.name }}
  idx: "{{ (index $svc.spec.ports 0).port }}"
  {{ end }}
{% endraw %}
```

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  {{- $deploys := (lookup "v1" "Pod" "ingress-nginx" "").items }}
  {{- range $deploy := $deploys }}
  pod: {{ $deploy.metadata.name }}
  {{- end }}
{% endraw %}
```

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  pods: |-
    {{- range $index, $pod := (lookup "v1" "Pod" "ingress-nginx" "").items }}
    - index: {{ $index }}
      pod: {{ $pod.metadata.name }}
    {{ end }}
{% endraw %}
```

```yaml
{% raw %}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-configmap
data:
  output: |
    {{- $deploy := (lookup "apps/v1" "Deployment" "ingress-nginx" "ingress-nginx-controller") }}
    {{- if $deploy }}
    pod: {{ $deploy.metadata.name }}
    replicas: {{ $deploy.spec.replicas }}
    {{- else }}
    pod: "not found"
    {{- end }}
{% endraw %}
```

```bash
helm upgrade meu-chart ./meu-chart 
```

## 10) Notes

Definir informação do chart **NOTES.txt**

```bash
Obrigado por instalar {{ .Chart.Name }}.
Seu release name é {{ .Release.Name }}.

Para mais informações sobre a release, execute:
$ helm status {{ .Release.Name }}
$ helm get all {{ .Release.Name }}
```

